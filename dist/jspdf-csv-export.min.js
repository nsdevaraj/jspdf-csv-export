/**
 * jsPDF CSV Streaming Implementation
 * A memory-efficient solution for exporting large CSV datasets to PDF
 * Version: 1.0.0
 * License: MIT
 * Date: 2025-03-11
 */

!function(){const t={formatFileSize:function(t){if(0===t)return"0 Bytes";const e=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,e)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][e]},formatNumber:function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},getMemoryInfo:function(){if(window.performance&&window.performance.memory){const t=window.performance.memory;return{totalJSHeapSize:this.formatFileSize(t.totalJSHeapSize),usedJSHeapSize:this.formatFileSize(t.usedJSHeapSize),jsHeapSizeLimit:this.formatFileSize(t.jsHeapSizeLimit),percentUsed:Math.round(t.usedJSHeapSize/t.jsHeapSizeLimit*100)}}return null},updateMemoryUsage:function(t){const e=this.getMemoryInfo();t.textContent=e?`Memory: ${e.usedJSHeapSize} / ${e.jsHeapSizeLimit} (${e.percentUsed}%)`:"Memory usage information not available"},delay:function(t){return new Promise((e=>setTimeout(e,t)))},checkBrowserSupport:function(){const t={fileReader:"undefined"!=typeof FileReader,promises:"undefined"!=typeof Promise,streams:"undefined"!=typeof ReadableStream,blob:"undefined"!=typeof Blob,supported:!1};return t.supported=t.fileReader&&t.promises&&t.streams&&t.blob,t},safeJsonParse:function(t,e={}){try{return JSON.parse(t)}catch(t){return e}},generateId:function(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}};window.Utils=t;class e{constructor(t={}){this.options={delimiter:",",header:!0,dynamicTyping:!0,skipEmptyLines:!0,...t},this.abortController=null,this.isProcessing=!1}parseFile(t,e={}){const{onChunk:i=()=>{},onComplete:o=()=>{},onError:r=()=>{},onProgress:s=()=>{}}=e;return new Promise(((e,n)=>{if(!t){const t=new Error("No file provided");return r(t),void n(t)}this.isProcessing=!0,this.abortController=new AbortController;const a=this.abortController.signal,d={...this.options,chunk:(t,e)=>{if(a.aborted)e.abort();else try{i(t.data)}catch(t){r(t),e.abort(),n(t)}},complete:t=>{this.isProcessing=!1,a.aborted||(o(t),e(t))},error:t=>{this.isProcessing=!1,r(t),n(t)},step:(t,e)=>{a.aborted&&e.abort()}},l=t.size;let h=0;const c=t=>{if(t.lengthComputable){h=t.loaded;const e=Math.round(h/l*100);s(e,h,l)}};Papa.parse(t,{...d,download:!1,beforeFirstChunk:function(){c({lengthComputable:!0,loaded:0})}});const p=new FileReader;p.onprogress=c,p.onload=()=>{c({lengthComputable:!0,loaded:l})},p.readAsArrayBuffer(t),a.addEventListener("abort",(()=>{this.isProcessing=!1,n(new Error("CSV parsing aborted"))}))}))}parseString(t){return Papa.parse(t,{...this.options,download:!1}).data}abort(){this.isProcessing&&this.abortController&&(this.abortController.abort(),this.isProcessing=!1)}static isCSVFile(t){if(!t)return!1;if("text/csv"===t.type||"application/vnd.ms-excel"===t.type)return!0;return"csv"===t.name.split(".").pop().toLowerCase()}static async estimateRowCount(t,e=1e5){return new Promise(((i,o)=>{const r=new FileReader;r.onload=e=>{try{const o=e.target.result,r=(o.match(/\n/g)||[]).length;if(0===r)return void i(1);const s=o.length/r,n=Math.ceil(t.size/s);i(n)}catch(t){o(t)}},r.onerror=()=>o(new Error("Error reading file"));const s=t.slice(0,Math.min(e,t.size));r.readAsText(s)}))}}window.CSVParser=e;class i{constructor(t={}){this.options={pageSize:"a4",orientation:"portrait",margins:{top:15,right:15,bottom:25,left:15},includeHeader:!0,includeFooter:!0,includePageNumbers:!0,title:"",author:"",fontSize:10,cellPadding:2,headerFillColor:[240,240,240],alternateRowFillColor:[249,249,249],...t},this.pdf=null,this.abortController=null,this.isGenerating=!1,this.currentPage=1,this.rowsProcessed=0,this.totalRows=0,this.columns=[],this.columnWidths=[],this.pageHeight=0,this.pageWidth=0,this.tableStartY=0,this.currentY=0,this.rowHeight=0,this.filename="export.pdf"}_initializePDF(){const{jsPDF:t}=window.jspdf;this.pdf=new t({orientation:this.options.orientation,unit:"mm",format:this.options.pageSize}),this.pageWidth=this.pdf.internal.pageSize.getWidth(),this.pageHeight=this.pdf.internal.pageSize.getHeight(),this.pdf.setFont("helvetica"),this.pdf.setFontSize(this.options.fontSize),this.rowHeight=this.options.fontSize/72*25.4+2*this.options.cellPadding,this.tableStartY=this.options.margins.top,this.currentY=this.tableStartY}async generatePDF(e,i,o,r={}){const{onProgress:s=()=>{},onComplete:n=()=>{},onError:a=()=>{},onPageAdded:d=()=>{}}=r;return new Promise((async(r,d)=>{try{this.isGenerating=!0,this.abortController=new AbortController;const a=this.abortController.signal;let l;this.totalRows=i,this.rowsProcessed=0,this.columns=e,this._initializePDF(),(this.options.title||this.options.author)&&this._addDocumentHeader(),this._calculateColumnWidths(),this.options.includeHeader&&this._addHeaderRow();let h=0;for(;(l=await o(h++))&&!a.aborted;)await this._processChunk(l),s(this.rowsProcessed,this.totalRows,this.currentPage),await t.delay(10);if(a.aborted)return void d(new Error("PDF generation aborted"));if(this.options.includeFooter)for(let t=1;t<=this.currentPage;t++)this.pdf.setPage(t),this._addFooter();this.isGenerating=!1,n(this.pdf),r(this.pdf)}catch(t){this.isGenerating=!1,a(t),d(t)}}))}async _processChunk(t){for(const e of t){if(this.abortController&&this.abortController.signal.aborted)break;this.currentY+this.rowHeight>this.pageHeight-this.options.margins.bottom&&this._addNewPage(),this._addDataRow(e,this.rowsProcessed%2==1),this.rowsProcessed++}}_calculateColumnWidths(){const t=(this.pageWidth-this.options.margins.left-this.options.margins.right)/this.columns.length;this.columnWidths=this.columns.map((()=>t))}_addHeaderRow(){const{left:t,top:e}=this.options.margins;this.pdf.setFillColor(...this.options.headerFillColor),this.pdf.rect(t,this.currentY,this.pageWidth-t-this.options.margins.right,this.rowHeight,"F"),this.pdf.setTextColor(0,0,0),this.columns.forEach(((e,i)=>{const o=t+this.columnWidths.slice(0,i).reduce(((t,e)=>t+e),0),r=this.currentY+this.rowHeight-this.options.cellPadding-1;this.pdf.setFont("helvetica","bold"),this.pdf.text(String(e),o+this.options.cellPadding,r),this.pdf.setFont("helvetica","normal")})),this.currentY+=this.rowHeight}_addDataRow(t,e=!1){const{left:i}=this.options.margins;e&&(this.pdf.setFillColor(...this.options.alternateRowFillColor),this.pdf.rect(i,this.currentY,this.pageWidth-i-this.options.margins.right,this.rowHeight,"F")),this.pdf.setTextColor(0,0,0),t.forEach(((t,e)=>{if(e>=this.columnWidths.length)return;const o=i+this.columnWidths.slice(0,e).reduce(((t,e)=>t+e),0),r=this.currentY+this.rowHeight-this.options.cellPadding-1,s=String(t||""),n=this.columnWidths[e]-2*this.options.cellPadding;this.pdf.text(s,o+this.options.cellPadding,r,{maxWidth:n})})),this.currentY+=this.rowHeight}_addNewPage(){this.pdf.addPage(),this.currentPage++,this.currentY=this.tableStartY,this.options.includeFooter&&this._addDocumentHeader(),this.options.includeHeader&&this._addHeaderRow()}_addDocumentHeader(){if(!this.options.title&&!this.options.author)return;const{left:t,top:e}=this.options.margins,i=this.pdf.getFontSize();this.options.title&&(this.pdf.setFontSize(14),this.pdf.setFont("helvetica","bold"),this.pdf.text(this.options.title,t,e-5)),this.options.author&&(this.pdf.setFontSize(10),this.pdf.setFont("helvetica","italic"),this.pdf.text(this.options.author,t,e)),this.pdf.setFontSize(i),this.pdf.setFont("helvetica","normal")}_addFooter(){if(!this.options.includeFooter)return;const t=this.pdf.getFontSize();this.pdf.setFontSize(8),this.pdf.setFont("helvetica","normal");const e=this.pageWidth,i=this.pageHeight,o=this.options.margins;if(this.options.includePageNumbers){const t=`Page ${this.currentPage}`,r=(e-8*this.pdf.getStringUnitWidth(t)/this.pdf.internal.scaleFactor)/2,s=i-o.bottom/2;this.pdf.text(t,r,s)}const r=(new Date).toLocaleString();this.pdf.setFontSize(7),this.pdf.text(r,o.left,i-o.bottom/2),this.pdf.setFontSize(t),this.pdf.setFont("helvetica","normal")}save(t="export.pdf"){if(!this.pdf)throw new Error("No PDF has been generated yet");return this.pdf.save(t),this.pdf.output("blob")}getBlob(){if(!this.pdf)throw new Error("No PDF has been generated yet");return this.pdf.output("blob")}getDataUrl(){if(!this.pdf)throw new Error("No PDF has been generated yet");return this.pdf.output("datauristring")}abort(){this.isGenerating&&this.abortController&&(this.abortController.abort(),this.isGenerating=!1)}}window.PDFGenerator=i,document.addEventListener("DOMContentLoaded",(()=>{const o=document.getElementById("csv-file-input"),r=document.querySelector(".file-drop-area"),s=document.getElementById("file-info"),n=document.getElementById("generate-pdf-btn"),a=document.getElementById("cancel-btn"),d=document.getElementById("progress-bar"),l=document.getElementById("progress-info"),h=document.getElementById("memory-usage"),c=document.getElementById("page-size"),p=document.getElementById("orientation"),u=document.getElementById("include-header"),g=document.getElementById("chunk-size");let f=null,m=0,w=null,b=null,y=null;t.checkBrowserSupport().supported||alert("Your browser does not support all features required for this application. Please use a modern browser like Chrome, Firefox, or Edge.");const S=()=>{y&&(clearInterval(y),y=null)};async function P(){if(C(),0===o.files.length)return;const i=o.files[0];if(!e.isCSVFile(i))return s.textContent="Error: Please select a valid CSV file.",void(s.style.color="red");f=i;try{s.textContent=`File: ${i.name} (${t.formatFileSize(i.size)})`,s.style.color="",m=await e.estimateRowCount(i),s.textContent+=` - Estimated rows: ${t.formatNumber(m)}`,n.disabled=!1}catch(t){s.textContent=`Error: ${t.message}`,s.style.color="red"}}function C(t=!1){n.disabled=!t,a.disabled=!0,t||(o.value="",f=null,m=0,s.textContent=""),S()}o.addEventListener("change",P),r.addEventListener("dragover",(t=>{t.preventDefault(),r.classList.add("drag-over")})),r.addEventListener("dragleave",(()=>{r.classList.remove("drag-over")})),r.addEventListener("drop",(t=>{t.preventDefault(),r.classList.remove("drag-over"),t.dataTransfer.files.length&&(o.files=t.dataTransfer.files,P())})),n.addEventListener("click",(async function(){if(!f)return;try{n.disabled=!0,a.disabled=!1,d.style.width="0%",l.textContent="Preparing...",y&&clearInterval(y),y=setInterval((()=>{t.updateMemoryUsage(h)}),1e3);const o={pageSize:c.value,orientation:p.value,includeHeader:u.checked,chunkSize:parseInt(g.value,10)};w=new e({header:!0,dynamicTyping:!0,skipEmptyLines:!0}),b=new i({pageSize:o.pageSize,orientation:o.orientation,includeHeader:o.includeHeader});const r=await async function(t){return new Promise(((e,i)=>{Papa.parse(t,{header:!0,preview:1,complete:t=>{t.data&&t.data.length>0?e(t.data[0]):i(new Error("Could not read CSV headers"))},error:t=>{i(t)}})}))}(f),s=Object.keys(r);let S=0;const P=async t=>w.abortController&&w.abortController.signal.aborted?null:new Promise((t=>{if(S>=Math.ceil(m/o.chunkSize))return void t(null);o.chunkSize,o.chunkSize;setTimeout((()=>{Papa.parse(f,{header:!0,dynamicTyping:!0,skipEmptyLines:!0,preview:o.chunkSize,step:(t,e)=>{},chunk:(e,i)=>{i.abort(),S++,t(e.data)},complete:()=>{S++,t([])},error:e=>{t([])}})}),0)}));await b.generatePDF(s,m,P,{onProgress:(e,i,o)=>{const r=Math.min(Math.round(e/i*100),100);d.style.width=`${r}%`,l.textContent=`Processing: ${t.formatNumber(e)} of ${t.formatNumber(i)} rows | Page: ${o}`},onComplete:e=>{l.textContent=`Completed: ${t.formatNumber(m)} rows processed`,d.style.width="100%",e.save(`${f.name.replace(".csv","")}_export.pdf`),setTimeout((()=>{C(!0)}),2e3)},onError:t=>{l.textContent=`Error: ${t.message}`,l.style.color="red",C()}})}catch(t){l.textContent=`Error: ${t.message}`,l.style.color="red",C()}finally{S()}})),a.addEventListener("click",(function(){w&&w.abort();b&&b.abort();l.textContent="Operation cancelled",C(),S()})),C()}))}("undefined"!=typeof window&&window);